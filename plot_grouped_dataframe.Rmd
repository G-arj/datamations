---
title: "Test(?) file for the package"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggwaffle)
library(gganimate)
library(pgog)
library(patchwork)
library(animation)
```


```{r}
data("small_salary_100")
```



# animate_group_by_sanddance


```{r}
# animate_group_by_sanddance(mtcars, cyl)
animate_group_by_sanddance(small_salary, Degree, is_last = TRUE)

# animate_group_by_sanddance(mtcars, cyl, am, nframes = 9)
animate_group_by_sanddance(small_salary, Degree, Work)
```


# animate_summarize_mean_sanddance

```{r}

# doesn't work
# grouped_mtcars <- mtcars %>% mutate(cyl = factor(cyl)) %>% group_by(cyl) 
# animate_summarize_mean_sanddance(grouped_mtcars, mpg) 

grouped_salaries <- small_salary %>% group_by(Degree)
animate_summarize_mean_sanddance(grouped_salaries, Salary, nframes = 5)

grouped_salaries2 <- small_salary %>% group_by(Degree, Work) 
animate_summarize_mean_sanddance(grouped_salaries2, Salary, nframes = 5)
```

## By steps

```{r}
animate_summarize_mean_sanddance(grouped_salaries2, Salary, nframes = 5, output = "first")

animate_summarize_mean_sanddance(grouped_salaries2, Salary, nframes = 5, output = "second")
```


# GIF export

## By step

```{r}
saveGIF({
  small_salary %>%
    animate_group_by_sanddance(Degree, nframes = 30, is_last = TRUE) 
}, movie.name="Degree_two_colors_groupby.gif", interval = 0.1, 
ani.width = 500, ani.height = 350, ani.res = 100)

```

```{r}
saveGIF({
  small_salary %>%
    group_by(Degree) %>%
    animate_summarize_mean_sanddance(Salary, nframes = 30)
}, movie.name="Degree_two_colors_summarizemean.gif", interval = 0.1, 
ani.width = 500, ani.height = 350, ani.res = 100)

```

```{r}
saveGIF({
  small_salary %>%
    animate_group_by_sanddance(Degree, Work, nframes = 30)
}, movie.name="Work_Degree_two_colors_groupby.gif", interval = 0.1, ani.width = 500, ani.height = 350, ani.res = 100)

```


```{r}
saveGIF({
  small_salary %>%
    group_by(Degree, Work) %>%
    animate_summarize_mean_sanddance(Salary, nframes = 30)
}, movie.name="Work_Degree_two_colors_summarizemean.gif", interval = 0.1, ani.width = 500, ani.height = 350,
 ani.res = 100)

```

## full movie

```{r}
saveGIF({
  small_salary %>%
    animate_group_by_sanddance(Degree, nframes = 30) %>%
    animate_summarize_mean_sanddance(Salary, nframes = 30)
}, movie.name="Degree_two_colors.gif", interval = 0.1, ani.width = 500, ani.height = 350, ani.res = 100)

```

```{r}
saveGIF({
  small_salary %>%
    animate_group_by_sanddance(Degree, Work, nframes = 30) %>%
    animate_summarize_mean_sanddance(Salary, nframes = 30)
}, movie.name="Work_Degree_two_colors.gif", interval = 0.1, ani.width = 500, ani.height = 350, ani.res= 100)

```

# gganimate experiments

```{r}
# ggplot(iris, aes(x = Petal.Width, y = Petal.Length)) +
#   geom_point() +
#   transition_states(Species) + 
#   view_follow()
  
```

```{r}
# ggplot(iris, aes(x = Petal.Width, y = Petal.Length)) +
#   geom_point() +
#   transition_states(Species) + 
#   view_zoom()
  
```

# recovering factor levels

```{r}
f <- factor(c("Master", "A", "A"))

dic <- tibble(f)  %>%
  select(where(~ ! is.numeric(.))) %>% 
  mutate_all(~ as.numeric(.)) %>%
  unique()

tibble(f) %>%
  # mutate(across(where(~ ! is.numeric(.))), mean)
  dplyr::mutate_if(~ !is.numeric(.), as.numeric)

n <- as.numeric(f)
tibble(n) %>%
  left_join(dic, by = "n")
```
```{r}
# df <- tibble(x = c("a", "b"), y = c(1, 1), z = c(-1, 1))
# df %>% dplyr::mutate(across(everything(), ~ .x / y))

```



# geom_point and icon array experiment

```{r}
mtcars %>%
  waffle_iron_groups(aes_d(group = cyl, x = cyl)) %>%
  ggplot(aes(x, y, color = factor(group))) + 
  geom_point(size = 3) + 
  coord_equal() +
  theme(
    panel.grid = element_blank(),
    panel.border = element_blank(),
    panel.background = element_blank(),
    axis.text = element_blank(),
    axis.title = element_blank(),
    axis.ticks = element_blank(),
    axis.line = element_blank(),
    axis.ticks.length = unit(0, "null"),
    # plot.title = element_text(size = 18),
    plot.background = element_blank(),
    # panel.spacing = unit(c(0, 0, 0, 0), "null")
  )

```
```{r}
mtcars %>%
  waffle_iron_groups(aes_d(group = cyl, x = cyl)) %>%
  ggplot(aes(x , y, fill = factor(group) )) + 
  geom_waffle() +
  coord_equal()
  # geom_tile(size = 2)
```
how to force a legend if there's no grouping aesthetics

```{r}
mtcars %>%
  waffle_iron_groups(aes_d(group = cyl, x = cyl)) %>%
  ggplot(aes(x , y, size = 1)) + 
  geom_point() +
  coord_equal() +
  theme(legend.title=element_blank())
```

Compare discrete v.s. continuous x axis

```{r}
p_factor <- mtcars %>%
  mutate(am = ifelse(am == 0, "Auto", "Manual")) %>%
  ggplot() + 
  geom_point(aes(factor(am), mpg)) 

p_numeric <- mtcars %>%
  ggplot(aes(am, mpg)) + 
  geom_point(aes(am, mpg))

p_factor + p_numeric

layer_scales(p_factor)$x$range

layer_scales(p_factor)$x$range_c

mtcars %>%
  ggplot() + 
  geom_point(aes(am, mpg))  + 
  scale_x_continuous(limits = c(0,1)) + 
  theme_inflight()
```

```{r}
p_factor <- ggplot(mtcars) + 
  geom_point(aes(factor(cyl), mpg, color = factor(cyl)))

p_numeric <- mtcars %>%
  ggplot(aes(cyl, mpg, color = cyl)) + 
  geom_point(aes(cyl, mpg, color = cyl))

p_factor + p_numeric
```

Changing labels on discrete scale

```{r}
mtcars %>%
  mutate(cyl = as.character(cyl)) %>%
  ggplot(aes(x = cyl, y = mpg)) + 
  geom_point() + 
  scale_x_discrete( labels = sapply(c(4,6,8), as.character)) # https://stackoverflow.com/questions/56284398/scale-x-discrete-5-ticks-with-3-labels

```


# CI length investigation

```{r}
ci_df <- readRDS("../../prototypes/pointinterval_df.rds")
ci_df

# ggdist changed interface :(
ggplot(ci_df) + 
  geom_pointinterval(
    aes(Degree_Work, Salary, ymin = .lower, ymax = .upper)
  ) 
```

```{r}
small_salary %>%
  boots_wrapper(Degree, Salary)
```
```{r}
small_salary %>%
  group_by(Degree) %>%
  summarize(.upper = Rmisc::CI(Salary)[3], .lower = Rmisc::CI(Salary)[1]) 
  
```

Conclusion: the bootstrapping function is fine... maybe it's just the sample size: 3000 v.s. 100 is a lot 


## Updating the small_salary

```{r}
# temp_df <- small_salary %>%
#   group_by(Degree, Work) %>%
#   mutate(Salary = (Salary - mean(Salary)) / 10 + mean(Salary),
#          Salary = round(Salary)) %>%
#   ungroup() %>%
#   mutate(Salary = ifelse(Degree == "PhD" & Work == "Academia", Salary + 1, Salary),
#          Salary = ifelse(Work == "Industry", Salary + 1, Salary))

temp_df <- small_salary %>%
  mutate(Salary = runif(n = n(), min = -0.5, max = 0.5) + Salary)
```

```{r}

p_work_degree <-temp_df %>%
  unite(Degree_Work, c("Work", "Degree") ) %>%
  group_by(Degree_Work) %>%
  summarize(mean = mean(Salary), 
            .upper = mean(Salary) + 1.96 * sd(Salary)/sqrt(n()),
            .lower = mean(Salary) - 1.96 * sd(Salary)/sqrt(n())) %>%
  # summarize(mean = mean(Salary), .upper = Rmisc::CI(Salary)[3], .lower = Rmisc::CI(Salary)[1])%>%
  ggplot(aes(x = Degree_Work, y = mean, ymin = .lower, ymax =.upper)) + 
  geom_pointrange()
  
```
```{r}
p_degree <- temp_df %>%
  group_by(Degree) %>%
  summarize(mean = mean(Salary), 
            .upper = mean(Salary) + 1.96 * sd(Salary)/sqrt(n()),
            .lower = mean(Salary) - 1.96 * sd(Salary)/sqrt(n())) %>%
  # summarize(mean = mean(Salary), .upper = Rmisc::CI(Salary)[3], .lower = Rmisc::CI(Salary)[1])%>%
  ggplot(aes(x = Degree, y = mean, ymin = .lower, ymax =.upper)) + 
  geom_pointrange()
```
```{r}
p_degree + p_work_degree
```



# Metaprogramming experiments
##  bang bang 

```{r}
varx <- sym("cyl_am")
aes_d(group = !!varx)
```

## rename()

```{r}
vars <- c(var1 = "cyl")
dplyr::rename(mtcars, !!vars)
dplyr::rename(mtcars, !!!vars)
```

## subset()

```{r}
res_var <- sym("mpg")
inter_coord <- mtcars 

str_res_var <- as.character(res_var)
select(inter_coord, !!res_var)
```

binding chr and numeric won't work (in Salary dataset). Can factors work?

```{r}
tibble(x = factor(c(1,2,3))) %>%
  bind_rows(tibble(x = 1:2))
```

